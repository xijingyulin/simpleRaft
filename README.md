# simpleRaft
这是基于Raft分布式数据服务器,一个关于Raft算法的简单实现.

数据以K-V形式存储，提供增加、删除、更新和查询功能.目前仅支持集群模式.许多地方仍然不太完善.

1.开始

18年底,产生一个想法,做一个类似zookeeper的分布式一致性服务器.只是,限制理想的不只有勇气,还有知识,以当时的我而言,一头雾水.

19年很忙,国庆后再次想起此事,开始学习zookeeper,了解到Paxos,但却又鬼使神差般想起到区块链,因为区块链也是能达成一致性的东西,2020年上半年,又花了不少时间在区块链上面,始终觉得挖矿这种方式不可取,过于浪费资源.一切又回到原点:还是得认真学习Paxos/Raft共识算法.

2020年7月份开始,翻译Raft算法论文《In Search of an Understandable Consensus Algorithm》,9月底完成,因为工作上许多事情,导致耗时很长,这是一个很炎热又很漫长的夏天.翻译完成后,但觉得Paxos在共识算法里面始终是绕不过去的基础算法(坑).

2020年10月国庆开始,翻译Leslie Lamport第二篇Paxos论文《Paxos Made Simple》,但这篇论文,正如许多人说的一点都不simple,这篇论文其实是由于第一篇论文《The Part-Time Parliament》在90年代发布时,过于难以理解,引起过多争议,所以才有了10年后发布的第二篇论文《Paxos Made Simple》.但是,对于作者本人而言,他的Paxos并不难理解,在翻译过程中,能感受到他对当年的事情耿耿于怀,论文摘要只有一句话:The Paxos algorithm, when presented in plain English, is very simple.Leslie Lamport以极为简练的语言写下这篇论文.

所以,要真的理解Paxos,还是要看最初的论文《The Part-Time Parliament》.

2020年10月底,《Paxos Made Simple》翻译完成,开始翻译Paxos最初的论文:《The Part-Time Parliament》.这是一个很长的考古故事,充满着口语和不那么正式的句子,将百度翻译和有道翻译一起用上,有些地方连句型都难分析清楚,毕竟我连6级都考不过.最终还是靠着个人理解将就地翻译.

2020年11月12号完成翻译.决定实现Raft算法加深对共识算法的理解,于2020年12月12日初步完成,耗时一个月.

2.The Part-Time Parliament基础教士协议

Paxos是三阶段提交的.先看《The Part-Time Parliament》基础教士协议的3个约束条件和6个步骤:

B1(β) 投票集β中的每个投票都有唯一的编号.

B2(β) 投票集β中任意两个投票的法定人数至少有一个相同的教士.

B3(β) 对于投票集β中的每个投票B,如果投票B的法定人数中的任意教士投票给投票集β中先前的投票,那么投票B的法令就等于先前投票中的最新投票的法令.

(1)教士p选择一个最大的新投票编号b,然后发送NextBallot(b)消息给个某个教士集.

(2)在接收到教士p发送的NextBallot(b)消息后,如果b大于自己最大的投票编号,教士q就接受处理这个消息,否则忽略.并且发送教士q投票过的最新投票LastVote(b, v)消息给教士p,其中v就是教士q投票过的最新投票的法令.

(3)从某个多数集Q每个教士中接收到LastVote(b, v)消息后,其中编号b和自己的新投票编号相同,教士p发起一个编号为b的新投票,法定人数Q,和法令d,其中d的选择满足B3条件.他然后发送BeginBallot(b, d)消息给Q中的每个教士.

(4)在接收到BeginBallot(b, d)消息后,并且b等于自己下次要投票的编号,教士q对编号为b的投票进行投票,然后回复投票成功消息Voted(b, q)给教士p.

(5)如果教士p从Q(投票编号为b的法定人数)的每个教士q中接收到Voted(b, q)消息,那么他就会将d(投票的法令)写到它的账本中并且发送Success(d)消息给每个教士.

(6)在接收到Success(d)消息后,教士将法令d写到他的账本中.

3.Paxos Made Simple并不simple

在这里,原本三阶段提交的Paxos协议,就变成了两阶段:准备请求和接受请求.

准备请求:

(1)提议者选择一个编号为n的提议,并且发送带有编号n的准备请求给多数接受者.

(2)如果接受者接收到带有编号n的准备请求,并且编号大于任何它已经响应过的准备请求,那么接受者就会响应这个请求并承诺不再接受任何编号小于n的提议,并返回它接受过的编号最大的提议(如果有的话).

接受请求:

(3)如果提议者从多数接受者那里,接收到它的准备请求(编号n)的响应,那么它会发送接受请求给那些接受者,接受请求里面包含编号为n值为v的提议,这个值v是响应中编号最大的提议的值,或者任意值,如果响应中没有提议的话.

(4)如果接受者接收到编号为n的提议的接受请求,它就会接受这个提议,除非它响应过拥有编号大于n的准备请求.

对比《The Part-Time Parliament》6个步骤,这里明显缺少了最后两个步骤,这两个步骤对应的就是提交的操作.不过在论文里面有一个学习者的角色,接受者接受提议后,就会发送给学习者.这也就是不simple的一个体现,特别地,在multi-paxos部分,讲的不太有条理,导致更加不simple.

4.Paxos Made Simple 中的协议一致性简单证明

如果选出了一个提议(n,v),编号为n,值为v.那么后续编号的更大的提议,选出来的值都为v.

证明:已选出提议(n,v),编号n+1的提议的值也为v.

A.既然选出了提议(n,v),那么多数接受者都拥有该提议.

B.在准备请求的步骤(2),接受者接收到编号为n+1的准备请求,那么至少有一个接受者会返回提议(n,v),因为n是仅次于n+1的编号.

C.至此,提议者发起新提议,编号为n+1,值为v.

关键在于多数接受者,不管是Paxos,还是Zab协议和Raft协议,多数集都是其中的核心.

5.Paxos的问题

提议者p完成提议编号n1的阶段1.另一个提议者q完成编号n2的阶段1(n2>n1).因为接受者都承诺不再接受任何编号小于n2的新提议,所有提议者p的阶段2对编号n1的提议的接受请求被忽略.这样,提议p接着开始并完成编号n3的新提议的阶段1(n3>n2),造成第二个的阶段2的提议者q的接受请求被忽略.诸如此类.

如果存在多个提议者,它们之间可能相互否定,导致无法选出一个值.只能保证最多只选出一个值,并不能保证一直有值.

为此,提出了选举主提议人, 让他发起提议.具体选举论文没有详细说明.

6.multi-paxos

以上描述的基础教士协议和后来简化版的二阶段提交协议,就是basic-Paxos,也称为单决策Paxos,对应的就是multi-paxos,也称为多决策Paxos.

basic-paxos最大的问题在于,只能选出一个值,真实的系统必定是,根据客户端的命令,会连续选出多个值.

multi-paxos:

A.basic-paxos作为一个实例，multi-paxos就是由多个实例组成,实例是可以无限多的.

B.选出领导者,统一由领导者发起提议.

C.领导者接收客户端命令,每个命令都有一个唯一的编号,而每个实例也有唯一一个编号,命令与实例编号一一对应.第i个实例执行第i个命令.

D.为了提高效率,可以批量执行每个实例的阶段1,那么后续的命令可以只执行阶段2,可以只发送的1条准备请求,都用同一个提议编号,每个接受者可以只回复一次,但回复里面包含所有实例的准备请求的响应.

E.凡是新选出来的领导者都需要执行阶段1.

F.如果由于崩溃恢复等原因,导致实例执行不连续,对执行的实例执行阶段1,如果该实例已经接受过提议,则将返回的提议,执行阶段2继续提交.反之，该实例没有接受过任何提议,可以直接用空操作命令填补.

G.每个命令从小到大逐个执行.

在后来知名的Zab协议和Raft协议,都可以看作是multi-paxos的变种实现.

7.raft

有三种角色:

领导者:集群的数据流是单向的,都是从领导者流向跟随者,读写操作都由领导者完成

候选者:选举期间才会存在的状态

跟随者:集群稳定时,除了领导者,其它都是跟随者,接收领导者的消息

任期:选举成功后,就是一个任期,在选举期间会递增任期号

索引:每条日志都有唯一递增的编号

raft选举:

(1)程序启动时,默认就是跟随者,如果在选举超时内,没有接收到领导者的消息(心跳或追加日志),就转成候选者

(2)候选者发送请求投票消息给各个服务器,如果接收到过半投票,就转成领导者

(3)跟随者接收到投票请求时,先比较任期号,大于自己,就投票;等于自己,再比较日志的索引,大于等于自己就投票;否则都拒绝.

(4)每个跟随者,在每个任期都最多只能投票一次.

(5)凡是接收到任期更大的消息,都会转成跟随者.

(6)选出领导者,领导者会立刻发送心跳消息给其它机器,从而维护领导者.

数据同步:

(1)一致性检查:领导者发送日志时,都会附带该条日志的上一条日志的任期和索引,跟随者接收到日志时,先根据上一条日志的任期和索引在自己的日志中寻找,如果能找到,则在其后追加日志,返回成功.否则,日志追加失败.

(2)一致性检查失败,领导者递减日志索引,重新发送日志,直到成功.

(3)领导者刚上任时,会发送空操作日志给每个跟随者,进行日志同步

8.paxos与raft

两者最大的区别在于,raft的日志必须是连续的;而paxos没有强制要求,可用空操作命令填补.

9.关于并行提交

取决于状态机有序还是无序,不管paxos还是raft.如果状态机是无序的,raft又为何不能多实例呢?
